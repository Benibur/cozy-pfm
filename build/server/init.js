// Generated by CoffeeScript 1.7.1
module.exports = function(app, server, callback) {
  var Bank, poller, reportManager;
  Bank = require('./models/bank');
  Bank.all(function(err, banks) {
    var CozyInstance, async;
    if (err || (banks != null ? banks.length : void 0) === 0) {
      async = require('async');
      CozyInstance = require('./models/cozyinstance');
      return CozyInstance.getInstance(function(err, instance) {
        var bankList, bankListFile, edenUrl, process;
        edenUrl = "http://www.enov.fr/mesinfos/";
        if ((instance != null) && (instance.helpUrl != null) && instance.helpUrl === edenUrl) {
          bankListFile = "banks-mesinfos.json";
        } else {
          bankListFile = "banks-all.json";
        }
        bankList = require("../tests/fixtures/" + bankListFile);
        process = function(bank, callback) {
          return Bank.create({
            name: bank.name,
            uuid: bank.uuid
          }, function(err) {
            if (err != null) {
              return callback(err);
            } else {
              return callback(null);
            }
          });
        };
        return async.each(bankList, process, function(err) {
          var msg;
          if (err != null) {
            msg = "Couldn't add the bank to the database -- " + err;
            console.log(msg);
          } else {
            msg = "Banks added to the database.";
            console.log(msg);
          }
          if (callback != null) {
            return callback(app, server);
          }
        });
      });
    } else {
      if (callback != null) {
        return callback(app, server);
      }
    }
  });
  console.log("Start bank accounts polling...");
  poller = require('./lib/accounts-poller');
  poller.start();
  console.log("Start alert watcher...");
  reportManager = require('./lib/report-manager');
  return reportManager.start();
};
